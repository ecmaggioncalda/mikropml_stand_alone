
#' Identify correlated features
#'
#' @param features Features used for machine learning.
#' @param corr_method correlation method. options or the same as those supported
#'   by `stats::cor`: spearman, pearson, kendall. (default: spearman)
#' @param group_neg_corr Whether to group negatively correlated features
#'   together (e.g. c(0,1) and c(1,0)).
#' @inheritParams run_ml
#'
#' @return Dataframe of correlated features where the columns are feature1,
#'   feature2, and the correlation between those two features
#'   (anything exceeding corr_thresh).
#' @export
#' @author Begüm Topçuoğlu, \email{topcuoglu.begum@@gmail.com}
#' @author Zena Lapp, \email{zenalapp@@umich.edu}
#'
#' @examples
#' set.seed(0)
#' mat <- matrix(runif(100), nrow = 20)
#' rownames(mat) <- 1:nrow(mat)
#' colnames(mat) <- 1:ncol(mat)
#' get_corr_feats(mat, 0.4)
#' @importFrom dplyr .data
get_corr_feats <- function(features, corr_thresh = 1, group_neg_corr = TRUE,
                           corr_method = "spearman") {
  corr_feats <- features %>%
    stats::cor(method = corr_method) %>%
    flatten_corr_mat()
  if (group_neg_corr) {
    corr_feats <- corr_feats %>%
      dplyr::filter(.data$corr >= corr_thresh | .data$corr <= -corr_thresh)
  } else {
    corr_feats <- corr_feats %>%
      dplyr::filter(.data$corr >= corr_thresh)
  }
  return(corr_feats)
}

#' Flatten correlation matrix to pairs
#'
#' @param cormat correlation matrix computed with stats::cor
#'
#' @return flattened correlation matrix (pairs of features their correlation)
#' @noRd
#' @author Zena Lapp, \email{zenalapp@@umich.edu}
#'
#' @examples
#' set.seed(0)
#' mat <- matrix(runif(100), nrow = 20)
#' rownames(mat) <- 1:nrow(mat)
#' colnames(mat) <- 1:ncol(mat)
#' corr_mat <- stats::cor(mat, method = "spearman")
#' flatten_corr_mat(corr_mat)
flatten_corr_mat <- function(cormat) {
  ut <- upper.tri(cormat)
  return(data.frame(
    feature1 = rownames(cormat)[row(cormat)[ut]],
    feature2 = rownames(cormat)[col(cormat)[ut]],
    corr = cormat[ut]
  ))
}

#' Group correlated features
#'
#' @param features data frame with each column as a feature for ML
#' @param corr_thresh correlation threshold (default: 1)
#' @inheritParams get_corr_feats
#' @return vector of correlated features where each element is a group of
#'   correlated features separated by pipes (|)
#' @noRd
#' @author Begüm Topçuoğlu, \email{topcuoglu.begum@@gmail.com}
#' @author Zena Lapp, \email{zenalapp@@umich.edu}
#'

group_correlated_features <- function(features, corr_thresh = 1,
                                      group_neg_corr = TRUE, corr_method = "spearman") {
  corr <- get_corr_feats(features,
                         corr_thresh = corr_thresh,
                         group_neg_corr = group_neg_corr,
                         corr_method = corr_method
  )

  all_features <- colnames(features)
  corr_features <- c(dplyr::pull(corr, feature1), 
                     dplyr::pull(corr, feature2)) %>% 
      unique
  uncorr_feature <- all_features[!all_features %in% corr_features]
  
  pasted_corr_features <- c()
  for(i in corr_features){
    pasted_feat <- corr %>% 
      dplyr::filter(feature1 == i | feature2 == i) %>% 
      tidyr::pivot_longer(cols = c(feature1, feature2), 
                          values_to = 'corr_feature') %>% 
      dplyr::pull(corr_feature) %>% 
      unique %>% 
      sort %>% 
      paste(collapse = '|')
    pasted_corr_features <- c(pasted_corr_features, pasted_feat)
  }
  output <- c(unique(pasted_corr_features), uncorr_feature)
}

